name: Cypress Tests & Allure Report

on:
  push:
    branches: [main, master, feature/workflow-test]
  pull_request:
    branches: [main, master]

permissions:
  contents: write

jobs:
  cypress-run:
    runs-on: ubuntu-latest
    timeout-minutes: 30
    services:
      mysql:
        image: mysql:8.0
        env:
          MYSQL_ROOT_PASSWORD: root
          MYSQL_DATABASE: qa_training
        ports:
          - 3306:3306
        options: >-
          --health-cmd="mysqladmin ping -h 127.0.0.1 -uroot -proot"
          --health-interval=10s
          --health-timeout=5s
          --health-retries=12

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: npm

      - name: Setup Java
        uses: actions/setup-java@v4
        with:
          distribution: temurin
          java-version: 21

      - name: Tool Versions
        shell: bash
        run: |
          node -v
          npm -v
          java -version
          npx cypress --version || true

      - name: Install Dependencies
        shell: bash
        run: |
          if [ -f package-lock.json ]; then
            npm install
          else
            npm install
          fi

      - name: Prepare .env for CI
        shell: bash
        env:
          DB_URL: ${{ secrets['CI_DB_URL'] }}
          DB_USERNAME: ${{ secrets['CI_DB_USERNAME'] }}
          DB_PASSWORD: ${{ secrets['CI_DB_PASSWORD'] }}
          API_BASE_URL: ${{ vars.CI_API_BASE_URL }}

          ADMIN_USER: ${{ secrets['CI_ADMIN_USER'] }}
          ADMIN_PASS: ${{ secrets['CI_ADMIN_PASS'] }}
          USER_USER: ${{ secrets['CI_USER_USER'] }}
          USER_PASS: ${{ secrets['CI_USER_PASS'] }}

          # Optional DB reset controls (recommended only for a dedicated CI database)
          DB_RESET_ALLOW_NON_LOCAL: ${{ vars.CI_DB_RESET_ALLOW_NON_LOCAL }}
          DB_RESET_ON_RUN: ${{ vars.CI_DB_RESET_ON_RUN }}
          DB_RESET_AFTER_RUN: ${{ vars.CI_DB_RESET_AFTER_RUN }}
          DB_RESET_SQL_FILE: ${{ vars.CI_DB_RESET_SQL_FILE }}
        run: |
          set -euo pipefail

          # Defaults for DB: use the workflow's MySQL service unless CI_DB_* secrets are provided.
          DB_URL="${DB_URL:-jdbc:mysql://127.0.0.1:3306/qa_training?useSSL=false&allowPublicKeyRetrieval=true}"
          DB_USERNAME="${DB_USERNAME:-root}"
          DB_PASSWORD="${DB_PASSWORD:-root}"

          missing=0
          for v in ADMIN_USER ADMIN_PASS USER_USER USER_PASS; do
            if [ -z "${!v:-}" ]; then
              echo "Missing required GitHub Secret: CI_${v}"
              missing=1
            fi
          done
          if [ "$missing" -ne 0 ]; then
            printf "\nSet these in GitHub → Settings → Secrets and variables → Actions → Secrets:\n"
            printf "- CI_ADMIN_USER, CI_ADMIN_PASS, CI_USER_USER, CI_USER_PASS\n"
            printf "\nOptional (Variables): CI_API_BASE_URL (defaults to http://localhost:8080)\n"
            printf "Optional (Variables) to enable DB resets on hosted DB (USE WITH CAUTION):\n"
            printf "- CI_DB_RESET_ALLOW_NON_LOCAL=true\n"
            printf "- CI_DB_RESET_ON_RUN=true\n"
            printf "- CI_DB_RESET_AFTER_RUN=true\n"
            printf "- CI_DB_RESET_SQL_FILE=sql/sample_plant_data_full.sql\n"
            exit 1
          fi

          # Defaults
          API_BASE_URL="${API_BASE_URL:-http://localhost:8080}"

          # Write .env safely (no heredoc indentation issues; values are quoted for dotenv).
          esc() {
            # Escape backslashes and double quotes for dotenv "..." values
            printf '%s' "$1" | sed -e 's/\\/\\\\/g' -e 's/"/\\"/g'
          }

          {
            echo "DB_USERNAME=\"$(esc "$DB_USERNAME")\"";
            echo "DB_PASSWORD=\"$(esc "$DB_PASSWORD")\"";
            echo "DB_URL=\"$(esc "$DB_URL")\"";
            echo "API_BASE_URL=\"$(esc "$API_BASE_URL")\"";
            echo "";
            echo "ADMIN_USER=\"$(esc "$ADMIN_USER")\"";
            echo "ADMIN_PASS=\"$(esc "$ADMIN_PASS")\"";
            echo "USER_USER=\"$(esc "$USER_USER")\"";
            echo "USER_PASS=\"$(esc "$USER_PASS")\"";
            echo "";
            echo "DB_RESET_ALLOW_NON_LOCAL=\"$(esc "${DB_RESET_ALLOW_NON_LOCAL:-}")\"";
            echo "DB_RESET_ON_RUN=\"$(esc "${DB_RESET_ON_RUN:-}")\"";
            echo "DB_RESET_AFTER_RUN=\"$(esc "${DB_RESET_AFTER_RUN:-}")\"";
            echo "DB_RESET_SQL_FILE=\"$(esc "${DB_RESET_SQL_FILE:-}")\"";
          } > .env

      - name: Start App (capture logs)
        id: app_start
        continue-on-error: true
        shell: bash
        run: |
          mkdir -p logs
          # Prefer API_BASE_URL from env or the generated .env, fallback to localhost.
          BASE_URL="${API_BASE_URL:-}"
          if [ -z "$BASE_URL" ] && [ -f .env ]; then
            BASE_URL="$(grep -E '^[[:space:]]*API_BASE_URL=' .env | tail -n 1 | sed -E 's/^[[:space:]]*API_BASE_URL=//')"
          fi
          # .env values may be quoted; strip surrounding quotes for shell usage.
          BASE_URL="${BASE_URL%\"}"
          BASE_URL="${BASE_URL#\"}"
          BASE_URL="${BASE_URL%\'}"
          BASE_URL="${BASE_URL#\'}"
          BASE_URL="${BASE_URL:-http://localhost:8080}"
          HEALTH_URL="${BASE_URL%/}/actuator/health"
          echo "health_url=${HEALTH_URL}" >> "$GITHUB_OUTPUT"

          # If running against a remote environment, don't start a local app.
          if [[ "$BASE_URL" == http://localhost:* || "$BASE_URL" == http://127.0.0.1:* ]]; then
            npm start > logs/app.log 2>&1 &
            echo $! > logs/app.pid
          else
            echo "Skipping local app start; using API_BASE_URL=$BASE_URL" | tee logs/app.log
          fi

          # Spring Boot + DB connections can take time; give it a bit longer.
          # 1) Ensure the server is listening (works even if /actuator/health is secured).
          if [[ "$BASE_URL" == http://localhost:* || "$BASE_URL" == http://127.0.0.1:* ]]; then
            npx wait-on --timeout 180000 tcp:localhost:8080
          fi

          # 2) Prefer a 200 from /actuator/health, but treat any HTTP response as "reachable".
          echo "Probing $HEALTH_URL ..." | tee -a logs/app.log
          for i in {1..60}; do
            http_code="$(curl -sS -o logs/health.json -w "%{http_code}" "$HEALTH_URL" || true)"
            if [[ "$http_code" == "200" ]]; then
              echo "Health OK (200)." | tee -a logs/app.log
              break
            fi
            if [[ "$http_code" != "000" && -n "$http_code" ]]; then
              echo "Health endpoint responded with HTTP $http_code (treating app as reachable)." | tee -a logs/app.log
              break
            fi
            sleep 3
          done

          # Fail only if we never got any HTTP response.
          if [[ ! -s logs/health.json ]]; then
                echo "DB_RESET_ALLOW_NON_LOCAL=\"$(esc \"${DB_RESET_ALLOW_NON_LOCAL:-false}\")\"";
                echo "DB_RESET_ON_RUN=\"$(esc \"${DB_RESET_ON_RUN:-true}\")\"";
                echo "DB_RESET_AFTER_RUN=\"$(esc \"${DB_RESET_AFTER_RUN:-true}\")\"";
                echo "DB_RESET_SQL_FILE=\"$(esc \"${DB_RESET_SQL_FILE:-sql/sample_plant_data_full.sql}\")\"";
            exit 1
          fi

      - name: Run Cypress Tests
        id: cypress
        if: steps.app_start.outcome == 'success'
        continue-on-error: true
        shell: bash
        run: npm test

      - name: App log tail (if app failed)
        if: steps.app_start.outcome != 'success'
        shell: bash
        run: |
          echo "App failed to become healthy; showing last 200 lines of logs/app.log"
          tail -n 200 logs/app.log || true

      - name: Cypress log tail (if tests failed)
        if: steps.cypress.outcome == 'failure'
        shell: bash
        run: |
          echo "Cypress step failed; showing last 200 lines of logs/app.log"
          tail -n 200 logs/app.log || true

      - name: Generate Allure Report
        if: always()
        run: |
          npx allure generate allure-results --clean -o allure-report || true

      - name: Upload Logs, Screenshots, Videos, Allure
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: test-artifacts
          path: |
            logs/
            cypress/screenshots/
            cypress/videos/
            allure-results/
            allure-report/
          retention-days: 30

      - name: Job Summary
        if: always()
        shell: bash
        run: |
          {
            echo "## Cypress CI Summary";
            echo "";
            echo "- App start: ${{ steps.app_start.outcome }}";
            echo "- Cypress: ${{ steps.cypress.outcome }}";
            echo "";
            echo "Artifacts: see the uploaded \"test-artifacts\" (logs/app.log, screenshots, allure-report).";
            echo "";
            echo "If the app failed to start against hosted MySQL, common causes are: IP not allowlisted, SSL required, wrong credentials.";
          } >> "$GITHUB_STEP_SUMMARY"

      - name: Stop App
        if: always()
        shell: bash
        run: |
          if [ -f logs/app.pid ]; then
            kill $(cat logs/app.pid) || true
          fi

      - name: Fail job if tests failed
        if: steps.cypress.outcome == 'failure'
        shell: bash
        run: |
          echo "Marking job failed because Cypress tests failed."
          exit 1

      - name: Fail job if app failed to start
        if: steps.app_start.outcome != 'success'
        shell: bash
        run: |
          echo "Marking job failed because the app did not become healthy at ${{ steps.app_start.outputs.health_url || '/actuator/health' }}."
          exit 1

  deploy-allure-report:
    needs: cypress-run
    runs-on: ubuntu-latest
    if: github.event_name == 'push' && (github.ref == 'refs/heads/main' || github.ref == 'refs/heads/master')
    permissions:
      contents: write
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Download test artifacts
        uses: actions/download-artifact@v4
        with:
          name: test-artifacts
          path: artifacts

      - name: Deploy Allure Report to GitHub Pages
        uses: peaceiris/actions-gh-pages@v3
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}
          publish_branch: gh-pages
          publish_dir: artifacts/allure-report
