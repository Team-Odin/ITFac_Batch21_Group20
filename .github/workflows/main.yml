name: Cypress Tests & Allure Report

on:
  push:
    branches: [main, master, manoj]
  pull_request:
    branches: [main, master]

permissions:
  contents: read

jobs:
  cypress-run:
    runs-on: ubuntu-latest
    timeout-minutes: 30
    env:
      TERM: xterm
      CI_FAIL_ON_TEST_FAILURE: ${{ secrets.CI_FAIL_ON_TEST_FAILURE }}
    services:
      mysql:
        image: mysql:8.0
        env:
          MYSQL_ROOT_PASSWORD: root
          MYSQL_DATABASE: qa_training
        ports:
          - 3306:3306
        options: >-
          --health-cmd="mysqladmin ping -h 127.0.0.1 -uroot -proot"
          --health-interval=10s
          --health-timeout=5s
          --health-retries=12

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: npm

      - name: Setup Java
        uses: actions/setup-java@v4
        with:
          distribution: temurin
          java-version: 21

      - name: Install Dependencies
        shell: bash
        run: |
          npm install

      - name: Prepare .env for CI
        shell: bash
        env:
          ADMIN_USER: ${{ secrets.CI_ADMIN_USER }}
          ADMIN_PASS: ${{ secrets.CI_ADMIN_PASS }}
          USER_USER: ${{ secrets.CI_USER_USER }}
          USER_PASS: ${{ secrets.UI_USER_PASS }}

          API_BASE_URL_SECRET: ${{ secrets.CI_API_BASE_URL }}
          DB_URL_SECRET: ${{ secrets.CI_DB_URL }}
          DB_USERNAME_SECRET: ${{ secrets.CI_DB_USERNAME }}
          DB_PASSWORD_SECRET: ${{ secrets.CI_DB_PASSWORD }}
          USE_REMOTE_DB: ${{ secrets.CI_USE_REMOTE_DB }}
        run: |
          set -euo pipefail

          # Defaults
          API_BASE_URL="${API_BASE_URL_SECRET:-http://localhost:8080}"

          # Write .env safely; values are quoted for dotenv.
          esc() {
            # Escape backslashes and double quotes for dotenv "..." values
            printf '%s' "$1" | sed -e 's/\\/\\\\/g' -e 's/"/\\"/g'
          }

          # Choose DB target:
          # - Local MySQL service (default)
          # - Remote DB via secrets when USE_REMOTE_DB is truthy
          use_remote="${USE_REMOTE_DB:-false}"
          shopt -s nocasematch
          if [[ "$use_remote" =~ ^(1|true|yes|y|on)$ ]]; then
            echo "Using REMOTE DB from secrets (CI_USE_REMOTE_DB=$USE_REMOTE_DB)"
            DB_URL="${DB_URL_SECRET:-}"
            DB_USERNAME="${DB_USERNAME_SECRET:-}"
            DB_PASSWORD="${DB_PASSWORD_SECRET:-}"

            # Safety: never reset remote DB by default.
            DB_RESET_ALLOW_NON_LOCAL="false"
            DB_RESET_ON_RUN="false"
            DB_RESET_AFTER_RUN="false"
            DB_RESET_SQL_FILE="sql/sample_plant_data_full.sql"
          else
            echo "Using LOCAL MySQL service (CI_USE_REMOTE_DB=$USE_REMOTE_DB)"
            DB_URL="jdbc:mysql://127.0.0.1:3306/qa_training?useSSL=false&allowPublicKeyRetrieval=true"
            DB_USERNAME="root"
            DB_PASSWORD="root"
            DB_RESET_ALLOW_NON_LOCAL="false"
            DB_RESET_ON_RUN="true"
            DB_RESET_AFTER_RUN="true"
            DB_RESET_SQL_FILE="sql/sample_plant_data_full.sql"
          fi
          shopt -u nocasematch

          # Login credentials:
          # - Prefer GitHub secrets when present
          # - Fall back to default training-app credentials so Cypress still runs and produces Allure output
          ADMIN_USER_VALUE="${ADMIN_USER:-admin}"
          ADMIN_PASS_VALUE="${ADMIN_PASS:-admin123}"
          USER_USER_VALUE="${USER_USER:-testuser}"
          USER_PASS_VALUE="${USER_PASS:-test123}"

          # Validate required values (especially for remote DB mode)
          missing=0
          for v in DB_URL DB_USERNAME DB_PASSWORD; do
            if [ -z "${!v:-}" ]; then
              echo "Missing required value: $v"
              missing=1
            fi
          done
          if [ "$missing" -ne 0 ]; then
            echo "\nRefusing to continue: database variables are not set."
            echo "If using remote DB, ensure CI_DB_URL/CI_DB_USERNAME/CI_DB_PASSWORD secrets are configured."
            exit 1
          fi

          {
            echo "DB_USERNAME=\"$(esc "$DB_USERNAME")\"";
            echo "DB_PASSWORD=\"$(esc "$DB_PASSWORD")\"";
            echo "DB_URL=\"$(esc "$DB_URL")\"";
            echo "API_BASE_URL=\"$(esc "$API_BASE_URL")\"";
            echo "";
            echo "ADMIN_USER=\"$(esc "$ADMIN_USER_VALUE")\"";
            echo "ADMIN_PASS=\"$(esc "$ADMIN_PASS_VALUE")\"";
            echo "USER_USER=\"$(esc "$USER_USER_VALUE")\"";
            echo "USER_PASS=\"$(esc "$USER_PASS_VALUE")\"";
            echo "";
            echo "DB_RESET_ALLOW_NON_LOCAL=\"$(esc "${DB_RESET_ALLOW_NON_LOCAL:-false}")\"";
            echo "DB_RESET_ON_RUN=\"$(esc "${DB_RESET_ON_RUN:-}")\"";
            echo "DB_RESET_AFTER_RUN=\"$(esc "${DB_RESET_AFTER_RUN:-}")\"";
            echo "DB_RESET_SQL_FILE=\"$(esc "${DB_RESET_SQL_FILE:-sql/sample_plant_data_full.sql}")\"";
          } > .env

          # Also export for subsequent steps (without relying on parsing .env).
          {
            echo "DB_URL=$DB_URL";
            echo "DB_USERNAME=$DB_USERNAME";
            echo "DB_PASSWORD=$DB_PASSWORD";
            echo "API_BASE_URL=$API_BASE_URL";
            echo "DB_RESET_ALLOW_NON_LOCAL=${DB_RESET_ALLOW_NON_LOCAL:-false}";
            echo "DB_RESET_ON_RUN=${DB_RESET_ON_RUN:-}";
            echo "DB_RESET_AFTER_RUN=${DB_RESET_AFTER_RUN:-}";
            echo "DB_RESET_SQL_FILE=${DB_RESET_SQL_FILE:-sql/sample_plant_data_full.sql}";
          } >> "$GITHUB_ENV"

      - name: Run Cypress Tests
        id: cypress
        continue-on-error: true
        shell: bash
        run: |
          echo "Using DB_URL=$DB_URL"
          npm test

      - name: Debug Allure Results
        if: always()
        shell: bash
        run: |
          set -euo pipefail
          echo "PWD=$(pwd)"
          if [ -d allure-results ]; then
            echo "allure-results exists"
            ls -la allure-results || true
            echo "allure-results file count: $(find allure-results -maxdepth 1 -type f | wc -l)"
          else
            echo "allure-results directory is missing"
          fi

      - name: Generate Allure Report
        if: always()
        continue-on-error: true
        shell: bash
        run: |
          set -euo pipefail

          mkdir -p allure-report

          if [ ! -d allure-results ] || [ -z "$(ls -A allure-results 2>/dev/null || true)" ]; then
            python3 -c "from pathlib import Path; Path('allure-report').mkdir(parents=True, exist_ok=True); Path('allure-report/index.html').write_text('<!doctype html>\\n<html lang=\"en\">\\n  <head>\\n    <meta charset=\"utf-8\" />\\n    <meta name=\"viewport\" content=\"width=device-width,initial-scale=1\" />\\n    <title>Allure Report (not available)</title>\\n  </head>\\n  <body>\\n    <h1>Allure Report not available</h1>\\n    <p>No <code>allure-results</code> were produced for this run.</p>\\n    <p>Check the workflow artifacts for screenshots/logs.</p>\\n  </body>\\n</html>\\n', encoding='utf-8')"
            exit 0
          fi

          if ! npx allure generate allure-results --clean -o allure-report; then
            python3 -c "from pathlib import Path; Path('allure-report').mkdir(parents=True, exist_ok=True); Path('allure-report/index.html').write_text('<!doctype html>\\n<html lang=\"en\">\\n  <head>\\n    <meta charset=\"utf-8\" />\\n    <meta name=\"viewport\" content=\"width=device-width,initial-scale=1\" />\\n    <title>Allure Report (generation failed)</title>\\n  </head>\\n  <body>\\n    <h1>Allure Report generation failed</h1>\\n    <p>The workflow attempted to run <code>allure generate</code> but it failed.</p>\\n    <p>Check the workflow logs and artifacts for details.</p>\\n  </body>\\n</html>\\n', encoding='utf-8')"
          fi

      - name: Upload Logs, Screenshots, Videos, Allure
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: test-artifacts
          path: |
            cypress/screenshots/
            cypress/videos/
            allure-results/
            allure-report/
          retention-days: 30

      - name: Fail job if tests failed
        if: steps.cypress.outcome == 'failure' && (env.CI_FAIL_ON_TEST_FAILURE == 'true')
        shell: bash
        run: |
          echo "Marking job failed because Cypress tests failed."
          exit 1

  deploy-allure-report:
    needs: cypress-run
    runs-on: ubuntu-latest
    if: always() && github.event_name == 'push' && (github.ref == 'refs/heads/main' || github.ref == 'refs/heads/master' || github.ref == 'refs/heads/manoj')
    permissions:
      contents: write
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Download test artifacts
        uses: actions/download-artifact@v4
        with:
          name: test-artifacts
          path: artifacts

      - name: Ensure report exists
        shell: bash
        run: |
          set -euo pipefail
          mkdir -p artifacts/allure-report
          if [ ! -f artifacts/allure-report/index.html ]; then
            python3 -c "from pathlib import Path; Path('artifacts/allure-report').mkdir(parents=True, exist_ok=True); Path('artifacts/allure-report/index.html').write_text('<!doctype html>\\n<html lang=\"en\">\\n  <head>\\n    <meta charset=\"utf-8\" />\\n    <meta name=\"viewport\" content=\"width=device-width,initial-scale=1\" />\\n    <title>Allure Report (missing)</title>\\n  </head>\\n  <body>\\n    <h1>Allure Report missing</h1>\\n    <p>The Allure report folder was not found in artifacts for this run.</p>\\n    <p>Check the workflow artifacts for screenshots/logs.</p>\\n  </body>\\n</html>\\n', encoding='utf-8')"
          fi

      - name: Deploy Allure Report to GitHub Pages
        uses: peaceiris/actions-gh-pages@v3
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}
          publish_branch: gh-pages
          publish_dir: artifacts/allure-report
