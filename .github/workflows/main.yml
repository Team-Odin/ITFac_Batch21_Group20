name: Cypress Tests & Allure Report

on:
  push:
    branches: [main, master, feature/workflow-test]
  pull_request:
    branches: [main, master]

permissions:
  contents: write

jobs:
  cypress-run:
    runs-on: ubuntu-latest
    timeout-minutes: 30

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: npm

      - name: Setup Java
        uses: actions/setup-java@v4
        with:
          distribution: temurin
          java-version: 21

      - name: Tool Versions
        shell: bash
        run: |
          node -v
          npm -v
          java -version
          npx cypress --version || true

      - name: Install Dependencies
        shell: bash
        run: |
          if [ -f package-lock.json ]; then
            npm ci
          else
            npm install
          fi

      - name: Prepare .env for CI
        shell: bash
        env:
          DB_URL: ${{ secrets['CI_DB_URL'] }}
          DB_USERNAME: ${{ secrets['CI_DB_USERNAME'] }}
          DB_PASSWORD: ${{ secrets['CI_DB_PASSWORD'] }}
          API_BASE_URL: ${{ vars['CI_API_BASE_URL'] || 'http://localhost:8080' }}

          ADMIN_USER: ${{ secrets['CI_ADMIN_USER'] }}
          ADMIN_PASS: ${{ secrets['CI_ADMIN_PASS'] }}
          USER_USER: ${{ secrets['CI_USER_USER'] }}
          USER_PASS: ${{ secrets['CI_USER_PASS'] }}

          # Optional DB reset controls (recommended only for a dedicated CI database)
          DB_RESET_ALLOW_NON_LOCAL: ${{ vars['CI_DB_RESET_ALLOW_NON_LOCAL'] }}
          DB_RESET_ON_RUN: ${{ vars['CI_DB_RESET_ON_RUN'] }}
          DB_RESET_AFTER_RUN: ${{ vars['CI_DB_RESET_AFTER_RUN'] }}
          DB_RESET_SQL_FILE: ${{ vars['CI_DB_RESET_SQL_FILE'] }}
        run: |
          set -euo pipefail

          missing=0
          for v in DB_URL DB_USERNAME DB_PASSWORD ADMIN_USER ADMIN_PASS USER_USER USER_PASS; do
            if [ -z "${!v:-}" ]; then
              if [[ "$v" == DB_* ]]; then
                echo "Missing required GitHub Secret: CI_${v}"
              else
                echo "Missing required GitHub Secret: CI_${v}"
              fi
              missing=1
            fi
          done
          if [ "$missing" -ne 0 ]; then
            printf "\nSet these in GitHub → Settings → Secrets and variables → Actions → Secrets:\n"
            printf "- CI_DB_URL, CI_DB_USERNAME, CI_DB_PASSWORD\n"
            printf "- CI_ADMIN_USER, CI_ADMIN_PASS, CI_USER_USER, CI_USER_PASS\n"
            printf "\nOptional (Variables): CI_API_BASE_URL (defaults to http://localhost:8080)\n"
            printf "Optional (Variables) to enable DB resets on hosted DB (USE WITH CAUTION):\n"
            printf "- CI_DB_RESET_ALLOW_NON_LOCAL=true\n"
            printf "- CI_DB_RESET_ON_RUN=true\n"
            printf "- CI_DB_RESET_AFTER_RUN=true\n"
            printf "- CI_DB_RESET_SQL_FILE=sql/sample_plant_data_full.sql\n"
            exit 1
          fi

          cat > .env <<EOF
          DB_USERNAME=${DB_USERNAME}
          DB_PASSWORD=${DB_PASSWORD}
          DB_URL=${DB_URL}
          API_BASE_URL=${API_BASE_URL}

          ADMIN_USER=${ADMIN_USER}
          ADMIN_PASS=${ADMIN_PASS}
          USER_USER=${USER_USER}
          USER_PASS=${USER_PASS}

          DB_RESET_ALLOW_NON_LOCAL=${DB_RESET_ALLOW_NON_LOCAL}
          DB_RESET_ON_RUN=${DB_RESET_ON_RUN}
          DB_RESET_AFTER_RUN=${DB_RESET_AFTER_RUN}
          DB_RESET_SQL_FILE=${DB_RESET_SQL_FILE}
          EOF

      - name: Start App (capture logs)
        id: app_start
        continue-on-error: true
        shell: bash
        run: |
          mkdir -p logs
          npm start > logs/app.log 2>&1 &
          echo $! > logs/app.pid

          npx wait-on --timeout 60000 http://localhost:8080/actuator/health
          curl -fsS http://localhost:8080/actuator/health | tee logs/health.json

      - name: Run Cypress Tests
        id: cypress
        if: steps.app_start.outcome == 'success'
        continue-on-error: true
        shell: bash
        run: npm test

      - name: App log tail (if app failed)
        if: steps.app_start.outcome != 'success'
        shell: bash
        run: |
          echo "App failed to become healthy; showing last 200 lines of logs/app.log"
          tail -n 200 logs/app.log || true

      - name: Cypress log tail (if tests failed)
        if: steps.cypress.outcome == 'failure'
        shell: bash
        run: |
          echo "Cypress step failed; showing last 200 lines of logs/app.log"
          tail -n 200 logs/app.log || true

      - name: Generate Allure Report
        if: always()
        run: |
          npx allure generate allure-results --clean -o allure-report || true

      - name: Upload Logs, Screenshots, Videos, Allure
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: test-artifacts
          path: |
            logs/
            cypress/screenshots/
            cypress/videos/
            allure-results/
            allure-report/
          retention-days: 30

      - name: Job Summary
        if: always()
        shell: bash
        run: |
          {
            echo "## Cypress CI Summary";
            echo "";
            echo "- App start: ${{ steps.app_start.outcome }}";
            echo "- Cypress: ${{ steps.cypress.outcome }}";
            echo "";
            echo "Artifacts: see the uploaded \"test-artifacts\" (logs/app.log, screenshots, allure-report).";
            echo "";
            echo "If the app failed to start against hosted MySQL, common causes are: IP not allowlisted, SSL required, wrong credentials.";
          } >> "$GITHUB_STEP_SUMMARY"

      - name: Stop App
        if: always()
        shell: bash
        run: |
          if [ -f logs/app.pid ]; then
            kill $(cat logs/app.pid) || true
          fi

      - name: Fail job if tests failed
        if: steps.cypress.outcome == 'failure'
        shell: bash
        run: |
          echo "Marking job failed because Cypress tests failed."
          exit 1

      - name: Fail job if app failed to start
        if: steps.app_start.outcome != 'success'
        shell: bash
        run: |
          echo "Marking job failed because the app did not become healthy at /actuator/health."
          exit 1

  deploy-allure-report:
    needs: cypress-run
    runs-on: ubuntu-latest
    if: github.event_name == 'push' && (github.ref == 'refs/heads/main' || github.ref == 'refs/heads/master')
    permissions:
      contents: write
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Download test artifacts
        uses: actions/download-artifact@v4
        with:
          name: test-artifacts
          path: artifacts

      - name: Deploy Allure Report to GitHub Pages
        uses: peaceiris/actions-gh-pages@v3
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}
          publish_branch: gh-pages
          publish_dir: artifacts/allure-report
